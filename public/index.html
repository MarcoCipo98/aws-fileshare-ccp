<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Secure File Share (CCP)</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; }
    button { padding: 10px 12px; cursor: pointer; }
    input { padding: 10px; width: 100%; box-sizing: border-box; margin: 8px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .muted { color: #666; }
    a { word-break: break-all; }
  </style>
</head>
<body>
  <h1>Secure File Share (AWS CCP Intro Project)</h1>
  <p class="muted">Step 1: S3 private uploads + DynamoDB metadata + presigned share links.</p>

  <div class="card">
    <h2>Environment</h2>
    <div class="row">
      <button id="btnHealth">GET /health</button>
      <button id="btnEnv">GET /env + /version</button>
    </div>
    <p id="envOut" class="mono muted"></p>
  </div>

  <div class="card">
    <h2>Upload file to S3 (private)</h2>
    <input id="fileInput" type="file"/>

    <button id="btnUpload">1) Upload</button>

    <label>fileId</label>
    <input id="fileId" placeholder="will be set after upload" />

    <button id="btnShare">2) Generate share link</button>

    <p id="status" class="mono muted"></p>
    <p id="shareOut" class="mono muted"></p>
  </div>

  <script>
    const envOut = document.getElementById("envOut");
    const statusEl = document.getElementById("status");
    const shareOut = document.getElementById("shareOut");
    const fileInput = document.getElementById("fileInput");
    const fileIdInput = document.getElementById("fileId");

    async function showEnv() {
      const env = await fetch("/env").then(r => r.json());
      const ver = await fetch("/version").then(r => r.json());
      envOut.textContent = `env=${env.env} version=${ver.version}`;
    }

    document.getElementById("btnHealth").addEventListener("click", async () => {
      statusEl.textContent = "Checking /health...";
      const res = await fetch("/health");
      statusEl.textContent = `Health: HTTP ${res.status} ${await res.text()}`;
    });

    document.getElementById("btnEnv").addEventListener("click", showEnv);
    showEnv().catch(() => {});

    document.getElementById("btnUpload").addEventListener("click", async () => {
      shareOut.textContent = "";
      const file = fileInput.files[0];
      if (!file) {
        statusEl.textContent = "Pick a file first.";
        return;
      }

      statusEl.textContent = "Requesting presigned upload URL...";

      // 1) Ask backend for presigned PUT URL
      const presignResp = await fetch("/files/presign-upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          originalFilename: file.name,
          contentType: file.type || "application/octet-stream"
        })
      });

      if (!presignResp.ok) {
        const t = await presignResp.text();
        statusEl.textContent = `Presign failed: HTTP ${presignResp.status} - ${t}`;
        return;
}
      const { fileId, uploadUrl } = await presignResp.json();
      fileIdInput.value = fileId;

      // 2) Upload file directly to S3 using the presigned URL
      statusEl.textContent = "Uploading file to S3...";
      const s3Put = await fetch(uploadUrl, {
        method: "PUT",
        headers: { "Content-Type": file.type || "application/octet-stream" },
        body: file
      });

      if (!s3Put.ok) {
        statusEl.textContent = `S3 upload failed: HTTP ${s3Put.status}`;
        return;
      }

      // 3) Tell backend upload is complete (so it verifies S3 object and marks READY)
      statusEl.textContent = "Finalizing upload...";
      const completeResp = await fetch("/files/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fileId })
      });

      if (!completeResp.ok) {
        const t = await completeResp.text();
        statusEl.textContent = `Complete failed: ${completeResp.status} ${t}`;
        return;
      }

      statusEl.textContent = "Upload complete. File is READY. Now generate a share link.";
    });

    document.getElementById("btnShare").addEventListener("click", async () => {
      shareOut.textContent = "";
      const fileId = fileIdInput.value.trim();
      if (!fileId) {
        statusEl.textContent = "fileId is empty. Upload first.";
        return;
      }

      statusEl.textContent = "Generating share link...";
      const resp = await fetch(`/files/${encodeURIComponent(fileId)}/share`, { method: "POST" });

      if (!resp.ok) {
        const t = await resp.text();
        statusEl.textContent = `Share failed: ${resp.status} ${t}`;
        return;
      }

      const data = await resp.json();
      statusEl.textContent = "Share link generated (expires soon).";
      shareOut.innerHTML = `Download: <a href="${data.downloadUrl}" target="_blank" rel="noreferrer">${data.downloadUrl}</a>`;
    });
  </script>
</body>
</html>
